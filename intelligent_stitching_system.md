# RabbitShot 智能拼接系统

## 🎯 解决的核心问题

### 1. 重复内容问题
**问题**：用户先向上滑动再向下滑动时，会产生重复内容的无限循环
**解决方案**：
- 实现全局内容区域管理系统
- 基于逻辑坐标的智能去重算法
- 支持双向滚动的内容跟踪

### 2. 连贯性问题
**问题**：生成的是多个小图拼接，而不是一张连贯的长图
**解决方案**：
- 全局坐标系统管理
- 真正的内容级别拼接
- 透明背景处理，避免白边

## 🚀 核心技术架构

### 1. 全局内容管理系统
```cpp
struct GlobalContentRegion {
    QRect logicalRect;    // 逻辑坐标系中的区域
    QPixmap image;        // 对应的图像内容
    int globalYOffset;    // 在全局拼接图中的Y偏移
};
```

### 2. 智能去重算法
- **全局区域检查**：检查所有历史内容，而不仅仅是最近的几个
- **逻辑坐标计算**：根据滚动方向正确计算新内容的逻辑位置
- **重叠区域相似度检查**：精确比较重叠区域的图像相似度

### 3. 双向滚动支持
```cpp
if (scrollInfo.direction == ScrollDirection::Down) {
    // 向下滚动：新内容在底部
    logicalRect = QRect(0, m_currentScrollPos, newContent.width(), newContent.height());
} else if (scrollInfo.direction == ScrollDirection::Up) {
    // 向上滚动：新内容在顶部
    logicalRect = QRect(0, m_globalBounds.top() - newContent.height(), 
                       newContent.width(), newContent.height());
}
```

## 🔧 关键改进

### 1. 全局坐标系统
- **逻辑坐标**：统一的坐标系统，不受滚动方向影响
- **全局边界**：动态计算和更新全局内容边界
- **相对位置计算**：在最终图像中正确计算各区域的相对位置

### 2. 智能内容检测
- **区域重叠检查**：精确检查新内容与已有区域的重叠
- **相似度阈值**：85%以上相似度认为是重复内容
- **最小重叠要求**：重叠区域小于20像素时忽略

### 3. 真正的无缝拼接
```cpp
// 计算在最终图片中的相对位置
int relativeX = region.logicalRect.x() - finalLogicalBounds.x();
int relativeY = region.logicalRect.y() - finalLogicalBounds.y();

// 绘制整个全局区域
painter.drawPixmap(relativeX, relativeY, region.image);
```

## 📊 工作流程

### 1. 初始化阶段
- 创建基础图片的全局区域
- 初始化全局坐标系统
- 设置当前滚动位置

### 2. 滚动检测阶段
- 检测滚动方向和偏移量
- 提取新内容区域
- 计算新内容的逻辑坐标

### 3. 智能去重阶段
- 检查与所有历史区域的重叠
- 计算重叠区域的相似度
- 决定是否添加新内容

### 4. 拼接生成阶段
- 计算所有区域的全局边界
- 创建最终尺寸的图像
- 按逻辑坐标绘制各区域

## 🎨 预期效果

### 1. 智能去重
- ✅ 向上滚动再向下滚动不会产生重复内容
- ✅ 基于内容相似度的精确去重
- ✅ 支持复杂的滚动模式

### 2. 无缝拼接
- ✅ 生成真正连贯的长图
- ✅ 无白边和间隙
- ✅ 内容完美对齐

### 3. 性能优化
- ✅ 采样优化的相似度计算
- ✅ 高效的区域管理
- ✅ 透明背景处理

## 🔍 调试信息

### 典型输出示例
```
开始滚动截图检测，基础图片尺寸: QSize(400, 982) 全局边界: QRect(0,0 400x982)
检测到向下滚动，偏移：120 重叠区域：QRect(0,862 400x120)
添加新内容：逻辑区域=QRect(0,982 400x150) Y偏移=862 重叠高度=120 滚动方向=2
更新全局区域：QRect(0,982 400x150) 全局边界：QRect(0,0 400x1132)
绘制全局区域：逻辑坐标=QRect(0,0 400x982) 相对位置=(0,0) 图片尺寸=QSize(400, 982)
绘制全局区域：逻辑坐标=QRect(0,982 400x150) 相对位置=(0,982) 图片尺寸=QSize(400, 150)
最终拼接图片尺寸：QSize(400, 1132) 逻辑边界：QRect(0,0 400x1132)
```

### 重复内容检测示例
```
检测到重复内容，相似度：0.92 逻辑区域：QRect(0,500 400x200) 重叠区域：QRect(0,500 400x200)
检测到重复内容，忽略
```

## 🎯 使用建议

### 1. 最佳实践
- **缓慢滚动**：给系统足够时间进行精确检测
- **均匀滚动**：保持恒定的滚动速度
- **丰富内容**：选择包含多样化内容的区域

### 2. 测试场景
- **简单向下滚动**：验证基本拼接功能
- **向上再向下滚动**：测试智能去重功能
- **复杂滚动模式**：测试系统的鲁棒性

### 3. 故障排除
- 查看控制台输出的详细调试信息
- 检查逻辑坐标计算是否正确
- 验证相似度阈值设置是否合适

## 🚀 技术优势

1. **智能化**：基于内容相似度的智能判断，而不是简单的时间或位置判断
2. **精确性**：精确的逻辑坐标系统，确保内容正确定位
3. **灵活性**：支持各种复杂的滚动模式
4. **高效性**：采样优化的算法，保证实时性能
5. **可扩展性**：模块化设计，易于扩展和维护

通过这个智能拼接系统，RabbitShot现在能够处理复杂的滚动场景，生成真正无缝的连贯长图，完全解决了重复内容和拼接质量问题！ 